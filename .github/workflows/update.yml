      - name: Fetch EDF half-hourly and compute band averages
        run: |
          set -euo pipefail

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")

          URL="https://acq-api.pri.cus-chnnls-sales-core.aws.edfcloud.io/half-hourly-unit-rates"

          curl -s -X POST "$URL" -H "Content-Type: application/json" -d "{\"date\":\"$TODAY\"}" > today.json
          curl -s -X POST "$URL" -H "Content-Type: application/json" -d "{\"date\":\"$TOMORROW\"}" > tomorrow.json

          jq '
            def to_hhmm:
              (.[:-1] | strptime("%Y-%m-%dT%H:%M:%S") | mktime | strftime("%H:%M"));

            # band takes its input (.) as the time string
            def band:
              . as $t
              | if   ($t >= "23:00" or $t < "06:00") then "green"
                elif ($t >= "06:00" and $t < "16:00") then "amber"
                elif ($t >= "16:00" and $t < "19:00") then "red"
                else "amber"
                end;

            def compute:
              .results
              | map({
                  value: .value_inc_vat,
                  t: (.valid_from | to_hhmm),
                  b: (.valid_from | to_hhmm | band)
                })
              | group_by(.b)
              | map({ (.[0].b): (map(.value) | add / length) })
              | add;

            {
              today:    ( input | compute | map_values(. as $v | ($v|tostring + " pence")) ),
              tomorrow: ( input | compute | map_values(. as $v | ($v|tostring + " pence")) ),
              times: {
                green: "23:00–06:00",
                amber: "06:00–16:00, 19:00–23:00",
                red:   "16:00–19:00"
              }
            }
          ' today.json tomorrow.json > data.json
