name: update freephase rates

permissions:
  contents: write

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:

      - name: checkout
        uses: actions/checkout@v4

      - name: install jq
        run: sudo apt-get install jq -y

      - name: fetch EDF half-hourly data and compute band prices
        run: |
          set -euo pipefail

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")

          EDF_URL="https://acq-api.pri.cus-chnnls-sales-core.aws.edfcloud.io/half-hourly-unit-rates"

          curl -s -X POST "$EDF_URL" \
            -H "Content-Type: application/json" \
            -d "{\"date\":\"$TODAY\"}" > today.json

          curl -s -X POST "$EDF_URL" \
            -H "Content-Type: application/json" \
            -d "{\"date\":\"$TOMORROW\"}" > tomorrow.json

          # Create jq band function
          cat > bandcalc.jq << 'EOF'
          def to_local:
            (.[:-1] | strptime("%Y-%m-%dT%H:%M:%S") | mktime | strftime("%H:%M"))
            ;

          def band($t):
            if ($t >= "23:00" or $t < "06:00") then "green"
            elif ($t >= "06:00" and $t < "16:00") then "amber"
            elif ($t >= "16:00" and $t < "19:00") then "red"
            else "amber"
            end;

          def compute:
            .results
            | map({val: .value_inc_vat, t: (.valid_from | to_local)})
            | group_by(.t | band(.))
            | map({ (.[0].t | band(.)): (map(.val) | add / length) })
            | add;

          {
            today:    ( (input | compute) | to_entries | map({key, value: (.value | tostring + " pence")}) | from_entries ),
            tomorrow: ( (input | compute) | to_entries | map({key, value: (.value | tostring + " pence")}) | from_entries ),
            times:
