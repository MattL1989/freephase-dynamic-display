name: Update FreePhase rates

on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.package.outputs.path }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt update
          sudo apt install -y jq

      - name: Fetch and process data
        run: |
          set -euo pipefail

          API="https://api.edfgb-kraken.energy/v1/products/EDF_FREEPHASE_DYNAMIC_12M_HH/electricity-tariffs/E-1R-EDF_FREEPHASE_DYNAMIC_12M_HH-E/standard-unit-rates/"

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")
          YDAY=$(date -u -d "yesterday" +"%Y-%m-%d")
          DAY_AFTER=$(date -u -d "+2 days" +"%Y-%m-%d")

          PERIOD_FROM="${YDAY}T00:00:00Z"
          PERIOD_TO="${DAY_AFTER}T23:59:59Z"

          curl -s "${API}?period_from=${PERIOD_FROM}&period_to=${PERIOD_TO}" > raw.json

          extract_dual() {
            local start1=$1
            local end1=$2
            local start2=$3
            local end2=$4

            jq -r \
              --arg s1 "$start1" --arg e1 "$end1" \
              --arg s2 "$start2" --arg e2 "$end2" '
                .results
                | map(select((.valid_from >= $s1 and .valid_from < $e1)
                           or (.valid_from >= $s2 and .valid_from < $e2)))
                | if length == 0 then null else
                    (
                      . as $items
                      | {
                          price: ($items | map(.value_inc_vat) | add / length),
                          start_list: ($items | map(.valid_from) | sort),
                          end_list:   ($items | map(.valid_to) | sort)
                        }
                    )
                  end
              ' raw.json
          }

          extract_single() {
            local start=$1
            local end=$2
            jq -r --arg s "$start" --arg e "$end" '
              .results
              | map(select(.valid_from >= $s and .valid_from < $e))
              | if length == 0 then null else
                  (. as $items | {
                    price: ($items | map(.value_inc_vat) | add / length),
                    start_list: ($items | map(.valid_from) | sort),
                    end_list:   ($items | map(.valid_to) | sort)
                  })
                end
            ' raw.json
          }

          # Today
          GREEN=$(extract_single "${YDAY}T23:00:00Z" "${TODAY}T06:00:00Z")
          AMBER=$(extract_dual "${TODAY}T06:00:00Z" "${TODAY}T16:00:00Z" "${TODAY}T19:00:00Z" "${TODAY}T23:00:00Z")
          RED=$(extract_single "${TODAY}T16:00:00Z" "${TODAY}T19:00:00Z")

          # Tomorrow
          GREEN_TM=$(extract_single "${TODAY}T23:00:00Z" "${TOMORROW}T06:00:00Z")
          AMBER_TM=$(extract_dual "${TOMORROW}T06:00:00Z" "${TOMORROW}T16:00:00Z" "${TOMORROW}T19:00:00Z" "${TOMORROW}T23:00:00Z")
          RED_TM=$(extract_single "${TOMORROW}T16:00:00Z" "${TOMORROW}T19:00:00Z")

          jq -n \
            --argjson tgreen "$GREEN" \
            --argjson tamber "$AMBER" \
            --argjson tred "$RED" \
            --argjson tmgreen "$GREEN_TM" \
            --argjson tmamber "$AMBER_TM" \
            --argjson tmred "$RED_TM" \
            '{
              today: {
                green: $tgreen,
                amber: $tamber,
                red: $tred
              },
              tomorrow: {
                green: $tmgreen,
                amber: $tmamber,
                red: $tmred
              }
            }' > data.json

      - name: Package site
        id: package
        run: |
          mkdir output
          cp index.html output/
          cp data.json output/
          echo "path=output" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: output

  deploy:
    needs: update
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
