name: update freephase rates

permissions:
  contents: write

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch EDF half-hourly and compute band prices
        run: |
          set -euo pipefail

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")

          EDF_URL="https://acq-api.pri.cus-chnnls-sales-core.aws.edfcloud.io/half-hourly-unit-rates"

          curl -s -X POST "$EDF_URL" \
            -H "Content-Type: application/json" \
            -d "{\"date\":\"$TODAY\"}" > today.json

          curl -s -X POST "$EDF_URL" \
            -H "Content-Type: application/json" \
            -d "{\"date\":\"$TOMORROW\"}" > tomorrow.json

          jq '
            def hh: .[:-1] | strptime("%Y-%m-%dT%H:%M:%S") | mktime | strftime("%H:%M");

            def band($t):
              if ($t >= "23:00" or $t < "06:00") then "green"
              elif ($t >= "06:00" and $t < "16:00") then "amber"
              elif ($t >= "16:00" and $t < "19:00") then "red"
              else "amber" end;

            def compute:
              .results
              | map({ b: ( .valid_from | hh | band ), v: .value_inc_vat })
              | group_by(.b)
              | map({ key: .[0].b, value: (map(.v) | add/length) })
              | from_entries;

            {
              today: ( (input | compute) | map_values(. as $v | "\($v) pence") ),
              tomorrow: ( (input | compute) | map_values(. as $v | "\($v) pence") )
            }
          ' today.json tomorrow.json > data.json

      - name: Commit updated data
        run: |
          git config user.name "auto-updater"
          git config user.email "actions@github.com"
          git add data.json
          git commit -m "update freephase rates" || echo "no changes"

      - name: Push
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
