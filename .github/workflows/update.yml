name: update freephase rates

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: fetch today and tomorrow from kraken
        run: |
          set -euo pipefail

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")

          BASE="https://api.edfgb-kraken.energy/v1/products/EDF_FREEPHASE_DYNAMIC_12M_HH/electricity-tariffs/E-1R-EDF_FREEPHASE_DYNAMIC_12M_HH-E/standard-unit-rates/"

          echo "Fetching today prices..."
          curl -s "${BASE}?page_size=96&period_from=${TODAY}T00:00Z&period_to=${TODAY}T23:59Z" > today_raw.json

          echo "Fetching tomorrow prices..."
          curl -s "${BASE}?page_size=96&period_from=${TOMORROW}T00:00Z&period_to=${TOMORROW}T23:59Z" > tomorrow_raw.json

          echo "First part of today_raw.json:"
          head -c 400 today_raw.json || true
          echo
          echo "First part of tomorrow_raw.json:"
          head -c 400 tomorrow_raw.json || true
          echo

          jq -s '
          {
            today:
              (.[0].results
               | map(.value_inc_vat)
               | unique
               | sort
               | {green: (.[0] | tostring + " pence"),
                  amber: (.[1] | tostring + " pence"),
                  red:   (.[2] | tostring + " pence")}),

            tomorrow:
              (.[1].results
               | map(.value_inc_vat)
               | unique
               | sort
               | {green: (.[0] | tostring + " pence"),
                  amber: (.[1] | tostring + " pence"),
                  red:   (.[2] | tostring + " pence")})
          }' today_raw.json tomorrow_raw.json > data.json

          echo "Built data.json:"
          cat data.json

      - name: commit updated data
        run: |
          git config user.name "auto-updater"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "update freephase rates" || echo "no changes"
          git push
