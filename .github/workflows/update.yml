name: Update FreePhase rates

on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch rates
        run: |
          set -euo pipefail

          API="https://api.edfgb-kraken.energy/v1/products/EDF_FREEPHASE_DYNAMIC_12M_HH/electricity-tariffs/E-1R-EDF_FREEPHASE_DYNAMIC_12M_HH-E/standard-unit-rates/"

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")
          YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")
          DAY_AFTER=$(date -u -d "+2 days" +"%Y-%m-%d")

          PERIOD_FROM="${YESTERDAY}T00:00:00Z"
          PERIOD_TO="${DAY_AFTER}T23:59:59Z"

          curl -s "${API}?period_from=${PERIOD_FROM}&period_to=${PERIOD_TO}" > raw.json

          # Gracefully allow empty EDF windows
          if ! jq -e '.results' raw.json >/dev/null 2>&1; then
            echo '{"today":{"green":null,"amber":null,"red":null},"tomorrow":{"green":null,"amber":null,"red":null}}' > data.json
            exit 0
          fi

          extract_band() {
            local start=$1
            local end=$2

            jq -r --arg s "$start" --arg e "$end" '
              .results
              | map(select(.valid_from >= $s and .valid_from < $e))
              | if length == 0 then null else
                  (
                    . as $items
                    | {
                        # EDF returns pence, keep pence
                        price: ($items | map(.value_inc_vat) | add / length),
                        start: ($items | map(.valid_from) | min),
                        end: ($items | map(.valid_to) | max),

                        band:
                          (if (($items | map(.value_inc_vat) | add / length) / 100) < 0.20
                            then "green"
                           elif (($items | map(.value_inc_vat) | add / length) / 100) < 0.30
                            then "amber"
                           else "red"
                          end)
                      }
                  )
                end
            ' raw.json
          }

          # Time windows
          GREEN_T_START="${YESTERDAY}T23:00:00Z"
          GREEN_T_END="${TODAY}T06:00:00Z"

          AMBER_T_START="${TODAY}T06:00:00Z"
          AMBER_T_END="${TODAY}T16:00:00Z"

          RED_T_START="${TODAY}T16:00:00Z"
          RED_T_END="${TODAY}T19:00:00Z"

          GREEN_TM_START="${TODAY}T23:00:00Z"
          GREEN_TM_END="${TOMORROW}T06:00:00Z"

          AMBER_TM_START="${TOMORROW}T06:00:00Z"
          AMBER_TM_END="${TOMORROW}T16:00:00Z"

          RED_TM_START="${TOMORROW}T16:00:00Z"
          RED_TM_END="${TOMORROW}T19:00:00Z"

          jq -n \
            --argjson tgreen "$(extract_band "$GREEN_T_START" "$GREEN_T_END")" \
            --argjson tamber "$(extract_band "$AMBER_T_START" "$AMBER_T_END")" \
            --argjson tred "$(extract_band "$RED_T_START" "$RED_T_END")" \
            --argjson tmgreen "$(extract_band "$GREEN_TM_START" "$GREEN_TM_END")" \
            --argjson tmamber "$(extract_band "$AMBER_TM_START" "$AMBER_TM_END")" \
            --argjson tmred "$(extract_band "$RED_TM_START" "$RED_TM_END")" \
            '{
              today: {
                green: $tgreen,
                amber: $tamber,
                red: $tred
              },
              tomorrow: {
                green: $tmgreen,
                amber: $tmamber,
                red: $tmred
              }
            }' > data.json

      - name: Commit updated data
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data.json raw.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update prices"
            git pull --rebase origin main || true
            git push origin main
          fi
