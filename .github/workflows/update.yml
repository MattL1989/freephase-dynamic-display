name: update freephase rates

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch Kraken banded rates
        run: |
          set -euo pipefail

          KRKN_URL="https://api.edfgb-kraken.energy/v1/products/EDF_FREEPHASE_DYNAMIC_12M_HH/electricity-tariffs/E-1R-EDF_FREEPHASE_DYNAMIC_12M_HH-E/standard-unit-rates/"

          curl -s "$KRKN_URL" > raw.json

          TODAY=$(date -u +"%Y-%m-%d")
          TOMORROW=$(date -u -d "+1 day" +"%Y-%m-%d")

          # Helper jq function to detect band by time
          cat > classify.jq << 'EOF'
          def band_from_times:
            .valid_from as $v
            | ($v | strptime("%Y-%m-%dT%H:%M:%SZ") | mktime) as $ts
            | ($ts | strftime("%H:%M")) as $t
            | if ($t >= "23:00" or $t < "06:00") then "green"
              elif ($t >= "06:00" and $t < "16:00") then "amber"
              elif ($t >= "16:00" and $t < "19:00") then "red"
              else "amber"
              end;

          def dayfilter($day):
            map(select(.valid_from | startswith($day)));

          def byband:
            map({
              band: band_from_times,
              price: .value_inc_vat,
              start: .valid_from,
              end: .valid_to
            })
            | group_by(.band)
            | map({ key: (.[0].band), value: .[0] })
            | from_entries;

          {
            today: (dayfilter($ENV.TODAY) | byband),
            tomorrow: (dayfilter($ENV.TOMORROW) | byband)
          }
          EOF

          TODAY="$TODAY" TOMORROW="$TOMORROW" jq -f classify.jq raw.json > data.json

      - name: Commit data.json
        run: |
          git config user.name "auto-updater"
          git config user.email "actions@github.com"
          git add data.json
          git commit -m "update freephase rates" || echo "No changes"
          git push
