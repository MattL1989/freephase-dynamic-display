<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDF FreePhase Dynamic</title>

<style>
body {
  background:#000;
  color:#fff;
  font-family:Segoe UI,Arial,sans-serif;
  text-align:center;
  margin:0;
}

header { padding:30px 0 10px; }
h1 { font-size:40px; margin-bottom:6px; }
.clock { color:#aaa; margin-bottom:24px; }

h2 { margin:36px 0 14px; }

.band-card {
  width:92%;
  margin:14px auto;
  padding:26px;
  border-radius:18px;
  font-size:26px;
  box-shadow:0 0 25px rgba(0,0,0,0.45);
}

.band-card.current {
  outline:3px solid #fff;
}

.green { background:#1f8f2e; }
.amber { background:#c9a200; }
.red   { background:#b00000; }

.greyed {
  opacity:0.35;
  border:2px dashed #666;
}

.dot {
  height:16px;
  width:16px;
  border-radius:50%;
  display:inline-block;
  margin-right:10px;
}

.dot.green { background:#58d46d; }
.dot.amber { background:#ffd84a; }
.dot.red { background:#ff4c4c; }

.price { font-size:34px; font-weight:600; margin:6px 0; }

footer {
  margin:50px 0 30px;
  color:#666;
  font-size:14px;
}
</style>
</head>

<body>

<header>
<h1>EDF FreePhase Dynamic - ST15 0WL</h1>
<div class="clock" id="clock"></div>
</header>

<h2>Today</h2>
<div id="today"></div>

<h2>Tomorrow</h2>
<div id="tomorrow"></div>

<hr style="margin:60px 0;opacity:0.25">

<h2>Set Charging Price Threshold</h2>
<p>Current threshold:</p>
<h2 id="current-threshold">Loading…</h2>

<input id="new-threshold" type="number" placeholder="Enter new threshold"
style="font-size:24px;padding:14px;width:260px;text-align:center;
border-radius:12px;border:2px solid #444;background:#222;color:#fff">

<br><br>
<button onclick="updateThreshold()"
style="padding:14px 28px;font-size:20px;border-radius:12px">Save</button>

<div id="threshold-status" style="margin-top:16px"></div>

<footer>
EDF FreePhase Display by Matt Lewis • Auto updated hourly via GitHub Actions
</footer>

<script>
/* CLOCK */
function updateClock() {
  document.getElementById("clock").textContent = new Date().toLocaleString("en-GB");
}
setInterval(updateClock, 1000);
updateClock();

/* CONFIG */
const BASELINE = 25.65;

const SUPABASE_URL = "https://pczxhzjdzcmojstavzym.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjenhoempkemNtb2pzdGF2enltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODAzOTksImV4cCI6MjA4MDc1NjM5OX0.OhWE9-HT0fFQUAdVQEkwp1PCLIfSsKOqQrZidK3cVxs";

/* HELPERS */
function pctText(price) {
  const p = ((BASELINE - price) / BASELINE) * 100;
  const dir = p >= 0 ? "▼" : "▲";
  return `${dir} ${Math.abs(p).toFixed(0)} percent ${p >= 0 ? "below" : "above"} baseline`;
}

function isCurrent(startIso, endIso) {
  if (!startIso || !endIso) return false;
  const now = new Date();
  return now >= new Date(startIso) && now < new Date(endIso);
}

function bandCard(band, data, timeLabel) {
  const pending = !data || data.price == null || !data.start || !data.end;
  const current = !pending && isCurrent(data.start, data.end);

  return `
    <div class="band-card ${band} ${pending ? "greyed" : ""} ${current ? "current" : ""}">
      <div><span class="dot ${band}"></span>${band.toUpperCase()}</div>
      ${pending
        ? `<div class="price">Price not yet published</div>`
        : `<div class="price">${Number(data.price).toFixed(2)}p per kWh</div>`}
      <div>${timeLabel}</div>
      ${pending ? `<div>Awaiting publication</div>` : `<div>${pctText(Number(data.price))}</div>`}
    </div>
  `;
}

function safeGet(obj, key) {
  return obj && Object.prototype.hasOwnProperty.call(obj, key) ? obj[key] : null;
}

/* NORMALISE DAY OBJECT INTO MORNING GREEN AND LATE GREEN */
function normaliseDay(dayObj) {
  const d = dayObj || {};

  let amber = safeGet(d, "amber");
  let red = safeGet(d, "red");

  let morningGreen = safeGet(d, "green_morning");
  let lateGreen = safeGet(d, "green_late");

  const singleGreen = safeGet(d, "green");

  if (!morningGreen && !lateGreen && singleGreen) {
    const start = new Date(singleGreen.start);
    const end = new Date(singleGreen.end);

    const startH = start.getUTCHours();
    const endH = end.getUTCHours();

    if (startH === 23 || endH === 0) lateGreen = singleGreen;
    else morningGreen = singleGreen;
  }

  if (!morningGreen && singleGreen && !lateGreen) {
    const end = new Date(singleGreen.end);
    if (end.getUTCHours() === 6) morningGreen = singleGreen;
  }

  return { morningGreen, lateGreen, amber, red };
}

/* DATA LOAD AND RENDER */
async function renderBands() {
  try {
    const url = "https://raw.githubusercontent.com/MattL1989/freephase-dynamic-display/main/data.json?ts=" + Date.now();
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error("data.json fetch failed");
    const data = await r.json();

    const todayData = data && data.today ? data.today : null;
    const tomorrowData = data && data.tomorrow ? data.tomorrow : null;

    const t = normaliseDay(todayData);
    const tm = normaliseDay(tomorrowData);

    document.getElementById("today").innerHTML = `
      ${bandCard("green", t.morningGreen, "00:01 - 06:00")}
      ${bandCard("amber", t.amber, "06:00 - 16:00 & 19:00 - 23:00")}
      ${bandCard("red", t.red, "16:00 - 19:00")}
      ${bandCard("green", t.lateGreen, "23:00 - 00:00")}
    `;

    document.getElementById("tomorrow").innerHTML = `
      ${bandCard("green", tm.morningGreen, "00:01 - 06:00")}
      ${bandCard("amber", tm.amber, "06:00 - 16:00 & 19:00 - 23:00")}
      ${bandCard("red", tm.red, "16:00 - 19:00")}
    `;
  } catch (e) {
    document.getElementById("today").innerHTML = `<div style="color:#ff8080;margin:20px">Render error</div>`;
    document.getElementById("tomorrow").innerHTML = "";
  }
}

/* SUPABASE */
async function loadThreshold() {
  try {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/settings?key=eq.threshold&select=value`,
      { headers:{ apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` }, cache:"no-store" }
    );
    if (!res.ok) throw new Error("threshold read failed");
    const data = await res.json();
    document.getElementById("current-threshold").innerText = data.length ? data[0].value : "Not set";
    document.getElementById("new-threshold").value = "";
  } catch (e) {
    document.getElementById("current-threshold").innerText = "Error";
  }
}

async function updateThreshold() {
  const v = document.getElementById("new-threshold").value;
  if (!v) return;

  try {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/settings?key=eq.threshold`,
      {
        method:"PATCH",
        headers:{
          "Content-Type":"application/json",
          apikey:SUPABASE_KEY,
          Authorization:`Bearer ${SUPABASE_KEY}`,
          Prefer:"return=representation"
        },
        body:JSON.stringify({ value:v })
      }
    );

    document.getElementById("threshold-status").innerText = res.ok ? "Saved" : "Error saving value";
    await loadThreshold();
  } catch (e) {
    document.getElementById("threshold-status").innerText = "Error saving value";
  }
}

/* START */
renderBands();
loadThreshold();
</script>

</body>
</html>
